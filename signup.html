<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sign Up - Promptify</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #0f0f0f 0%, #1a1a1a 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
      color: #ffffff;
    }
    
    .signup-container {
      background: rgba(255, 255, 255, 0.03);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 24px;
      padding: 48px;
      max-width: 480px;
      width: 100%;
      box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5);
    }
    
    .logo-container {
      width: 96px;
      height: 96px;
      margin: 0 auto 24px;
      background: #ffffff;
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      padding: 12px;
    }
    
    .logo-container img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .logo-fallback {
      font-size: 32px;
      font-weight: 700;
      color: #000000;
      letter-spacing: -1px;
    }
    
    h1 {
      text-align: center;
      font-size: 32px;
      margin-bottom: 8px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }
    
    .subtitle {
      text-align: center;
      color: #94a3b8;
      font-size: 15px;
      margin-bottom: 36px;
      line-height: 1.5;
    }
    
    .features-list {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 32px;
    }
    
    .features-title {
      font-size: 13px;
      font-weight: 600;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 16px;
    }
    
    .feature-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 0;
    }
    
    .feature-item:not(:last-child) {
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .feature-icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #ffffff;
      font-size: 14px;
      flex-shrink: 0;
    }
    
    .feature-text {
      color: #e2e8f0;
      font-size: 14px;
      line-height: 1.5;
    }
    
    /* Google Sign-In Button Container */
    #google-signin-button {
      width: 100%;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
    }
    
    .signin-link {
      text-align: center;
      margin-top: 24px;
      font-size: 14px;
      color: #94a3b8;
    }
    
    .signin-link a {
      color: #ffffff;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s ease;
      cursor: pointer;
    }
    
    .signin-link a:hover {
      color: #e2e8f0;
      text-decoration: underline;
    }
    
    .error-box {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px;
      color: #fca5a5;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
      line-height: 1.5;
    }
    
    .error-box i {
      margin-right: 8px;
    }
    
    .success-box {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      border-radius: 12px;
      padding: 16px;
      color: #6ee7b7;
      font-size: 14px;
      margin-bottom: 20px;
      display: none;
      line-height: 1.5;
    }
    
    .success-box i {
      margin-right: 8px;
    }
    
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 10000;
    }
    
    .loading-content {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 16px;
      padding: 32px;
      text-align: center;
    }
    
    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.1);
      border-top-color: #ffffff;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }
    
    .loading-text {
      color: #ffffff;
      font-size: 16px;
      font-weight: 500;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div class="signup-container">
    <div class="logo-container">
      <img id="logo-img" src="icons/logo_inv.png" alt="Promptify" onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';">
      <div id="logo-fallback" class="logo-fallback" style="display: none;">P</div>
    </div>
    
    <h1>Create Your Account</h1>
    <p class="subtitle">Join Promptify to enhance your AI prompts with advanced optimization</p>
    
    <div id="error-box" class="error-box"></div>
    <div id="success-box" class="success-box"></div>
    
    <div class="features-list">
      <div class="features-title">Free Account Includes</div>
      <div class="feature-item">
        <div class="feature-icon"><i class="fas fa-wand-magic-sparkles"></i></div>
        <div class="feature-text">Unlimited prompt enhancements</div>
      </div>
      <div class="feature-item">
        <div class="feature-icon"><i class="fas fa-folder"></i></div>
        <div class="feature-text">Organize prompts in folders</div>
      </div>
      <div class="feature-item">
        <div class="feature-icon"><i class="fas fa-cloud"></i></div>
        <div class="feature-text">Access your prompts anywhere</div>
      </div>
    </div>
    
    <!-- Google Sign-In Button (rendered by Google) -->
    <div id="google-signin-button"></div>
    
    <div class="signin-link">
      Already have an account? <a id="signin-link">Sign in</a>
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Creating your account...</div>
    </div>
  </div>
  
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script>
    // ‚ö†Ô∏è CONFIGURATION - REPLACE THESE VALUES
    const WORKER_URL = 'https://promptify-auth-api.promptify-api.workers.dev';
    const GOOGLE_CLIENT_ID = '1011255099010-pesp94vl5sej9pb15gudcoa9nbg68i2i.apps.googleusercontent.com';
    
    const errorBox = document.getElementById('error-box');
    const successBox = document.getElementById('success-box');
    const loadingOverlay = document.getElementById('loading-overlay');
    const signinLink = document.getElementById('signin-link');
    
    let isProcessing = false;
    
    function showError(message) {
      errorBox.innerHTML = `<i class="fas fa-exclamation-circle"></i>${message}`;
      errorBox.style.display = 'block';
      successBox.style.display = 'none';
    }
    
    function showSuccess(message) {
      successBox.innerHTML = `<i class="fas fa-check-circle"></i>${message}`;
      successBox.style.display = 'block';
      errorBox.style.display = 'none';
    }
    
    function hideMessages() {
      errorBox.style.display = 'none';
      successBox.style.display = 'none';
    }
    
    function showLoading() {
      loadingOverlay.style.display = 'flex';
    }
    
    function hideLoading() {
      loadingOverlay.style.display = 'none';
    }
    
    // Initialize Google Sign-In when the library loads
    window.onload = function() {
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false,
      });
      
      // Render the sign-in button
      google.accounts.id.renderButton(
        document.getElementById('google-signin-button'),
        {
          theme: 'filled_white',
          size: 'large',
          width: 400,
          text: 'signup_with',
          shape: 'rectangular',
          logo_alignment: 'left'
        }
      );
      
      console.log('‚úÖ Google Sign-In initialized');
    };
    
    // Handle the credential response from Google
    async function handleCredentialResponse(response) {
      if (isProcessing) return;
      
      hideMessages();
      showLoading();
      isProcessing = true;
      
      try {
        // Decode the JWT token from Google
        const credential = response.credential;
        const payload = JSON.parse(atob(credential.split('.')[1]));
        
        const googleUser = {
          id: payload.sub,
          email: payload.email,
          name: payload.name,
          picture: payload.picture
        };
        
        console.log('üìß Google sign-in successful:', googleUser.email);
        
        // Create account in your database
        console.log('üì° Sending to worker:', WORKER_URL);
        const signupResponse = await fetch(`${WORKER_URL}/register-user`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            google_id: googleUser.id,
            email: googleUser.email,
            name: googleUser.name,
            picture: googleUser.picture,
            subscription_tier: 'free'
          })
        });
        
        if (!signupResponse.ok) {
          const errorText = await signupResponse.text();
          console.error('‚ùå Server error:', signupResponse.status, errorText);
          throw new Error(`Server error: ${signupResponse.status}`);
        }
        
        const data = await signupResponse.json();
        console.log('üì• Server response:', data);
        
        if (data.success) {
          console.log('‚úÖ Account created successfully');
          
          // Prepare user data
          const userData = {
            id: googleUser.id,
            email: googleUser.email,
            name: googleUser.name,
            picture: googleUser.picture,
            tier: data.tier || 'free',
            signedInAt: Date.now()
          };
          
          // Check if opened from extension
          const urlParams = new URLSearchParams(window.location.search);
          const fromExtension = urlParams.get('from') === 'extension';
          
          hideLoading();
          showSuccess('Account created successfully! ' + (fromExtension ? 'You can now close this tab.' : 'Redirecting...'));
          
          // Store user data
          if (typeof chrome !== 'undefined' && chrome.storage) {
            // Extension context
            chrome.storage.local.set({ promptify_user: userData }, () => {
              setTimeout(() => {
                if (fromExtension) {
                  window.close();
                } else {
                  window.location.href = '/';
                }
              }, 2000);
            });
          } else {
            // Web context
            localStorage.setItem('promptify_user', JSON.stringify(userData));
            setTimeout(() => {
              window.location.href = '/';
            }, 2000);
          }
        } else {
          throw new Error(data.message || 'Failed to create account');
        }
        
      } catch (error) {
        console.error('‚ùå Signup error:', error);
        hideLoading();
        showError('Failed to create account. Please try again or contact support.');
        isProcessing = false;
      }
    }
    
    // Sign in link handler
    signinLink.addEventListener('click', (e) => {
      e.preventDefault();
      
      const urlParams = new URLSearchParams(window.location.search);
      const fromExtension = urlParams.get('from') === 'extension';
      
      if (fromExtension) {
        // Close this tab and let them sign in from extension
        alert('Please use the "Sign In" button in the Promptify extension settings.');
        window.close();
      } else {
        // Redirect to signin page
        window.location.href = '/signin.html';
      }
    });
  </script>
</body>
</html>