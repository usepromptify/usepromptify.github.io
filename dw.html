<!DOCTYPE html>
<html>
<head>
  <title>Test Secrets Configuration</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #1a1a1a;
      color: #fff;
    }
    button {
      padding: 12px 24px;
      margin: 10px 0;
      cursor: pointer;
      background: #10b981;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
    }
    button:hover {
      background: #059669;
    }
    pre {
      background: #000;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .success { color: #10b981; }
    .error { color: #ef4444; }
    .warning { color: #fbbf24; }
  </style>
</head>
<body>
  <h1>üîç Promptify Secrets Test</h1>
  <p>This will test if your Cloudflare worker has all secrets configured correctly.</p>
  
  <button onclick="runTests()">Run All Tests</button>
  
  <pre id="output"></pre>
  
  <script>
    const WORKER_URL = 'https://promptify-stripe.promptify-api.workers.dev';
    const output = document.getElementById('output');
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const className = type === 'error' ? 'error' : (type === 'success' ? 'success' : (type === 'warning' ? 'warning' : ''));
      output.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
    }
    
    async function runTests() {
      output.innerHTML = '';
      log('Starting diagnostic tests...\n');
      
      // Test 1: Worker responds
      log('TEST 1: Checking if worker is accessible...');
      try {
        const response = await fetch(`${WORKER_URL}/subscription-status?google_id=test`);
        log(`Worker response: ${response.status}`, response.ok ? 'success' : 'warning');
        
        if (response.ok) {
          log('‚úÖ Worker is accessible', 'success');
        } else if (response.status === 404) {
          log('‚ö†Ô∏è Worker responds but user not found (expected)', 'warning');
        } else {
          const text = await response.text();
          log(`‚ùå Worker error: ${text}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Cannot reach worker: ${error.message}`, 'error');
        log('Make sure worker URL is correct!', 'error');
        return;
      }
      
      log('\n');
      
      // Test 2: Database binding
      log('TEST 2: Checking database binding...');
      try {
        const response = await fetch(`${WORKER_URL}/subscription-status?google_id=test`);
        const text = await response.text();
        
        if (text.includes('Database not configured')) {
          log('‚ùå DB binding is missing!', 'error');
          log('Fix: Add D1 binding named "DB" in worker settings', 'error');
        } else if (text.includes('User not found') || text.includes('tier')) {
          log('‚úÖ Database is connected', 'success');
        } else {
          log(`‚ö†Ô∏è Unexpected response: ${text}`, 'warning');
        }
      } catch (error) {
        log(`‚ùå Database test failed: ${error.message}`, 'error');
      }
      
      log('\n');
      
      // Test 3: Create checkout (requires signed-in user)
      log('TEST 3: Checking Stripe configuration...');
      
      const userData = localStorage.getItem('promptify_user');
      if (!userData) {
        log('‚ö†Ô∏è Not signed in - cannot test Stripe fully', 'warning');
        log('Sign up first at signup.html to run full test', 'warning');
        return;
      }
      
      const user = JSON.parse(userData);
      log(`Testing with user: ${user.email}`);
      
      try {
        const response = await fetch(`${WORKER_URL}/create-checkout-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            google_id: user.id,
            email: user.email
          })
        });
        
        const text = await response.text();
        
        if (text.includes('Stripe not configured') || text.includes('STRIPE_SECRET_KEY')) {
          log('‚ùå STRIPE_SECRET_KEY is missing!', 'error');
          log('Fix: Add STRIPE_SECRET_KEY in worker settings', 'error');
        } else if (text.includes('price not configured') || text.includes('STRIPE_PRICE_ID')) {
          log('‚ùå STRIPE_PRICE_ID is missing!', 'error');
          log('Fix: Add STRIPE_PRICE_ID in worker settings', 'error');
        } else if (text.includes('User not found')) {
          log('‚ùå User not in database', 'error');
          log('Sign up at signup.html first', 'error');
        } else if (text.includes('Invalid API Key')) {
          log('‚ùå STRIPE_SECRET_KEY is invalid!', 'error');
          log('Fix: Use correct key from Stripe dashboard', 'error');
        } else if (text.includes('No such price')) {
          log('‚ùå STRIPE_PRICE_ID is invalid!', 'error');
          log('Fix: Use correct price ID from Stripe products', 'error');
        } else if (response.ok) {
          const data = JSON.parse(text);
          if (data.url) {
            log('‚úÖ All Stripe secrets are configured correctly!', 'success');
            log(`Checkout URL generated: ${data.url}`, 'success');
          }
        } else {
          log(`‚ùå Unexpected error: ${text}`, 'error');
        }
      } catch (error) {
        log(`‚ùå Stripe test failed: ${error.message}`, 'error');
      }
      
      log('\n');
      log('='.repeat(50));
      log('Tests complete!');
    }
  </script>
</body>
</html>